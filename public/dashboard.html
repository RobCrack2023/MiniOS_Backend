<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniOS - Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body x-data="app()" x-init="init()">

    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2>MiniOS</h2>
            <nav>
                <a href="#" :class="{ active: currentView === 'devices' }" @click.prevent="currentView = 'devices'">
                    Dispositivos
                </a>
                <a href="#" :class="{ active: currentView === 'firmware' }" @click.prevent="currentView = 'firmware'">
                    Firmware / OTA
                </a>
                <a href="#" :class="{ active: currentView === 'settings' }" @click.prevent="currentView = 'settings'">
                    Configuraci√≥n
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 x-text="viewTitle"></h1>
                <div class="user-info">
                    <span x-text="user?.username"></span>
                    <button class="btn btn-sm" @click="logout()">Salir</button>
                </div>
            </header>

            <!-- Stats -->
            <div class="stats-grid" x-show="currentView === 'devices'">
                <div class="stat-card">
                    <h3>Total Dispositivos</h3>
                    <div class="value" x-text="devices.length"></div>
                </div>
                <div class="stat-card online">
                    <h3>En L√≠nea</h3>
                    <div class="value" x-text="devices.filter(d => d.is_online).length"></div>
                </div>
                <div class="stat-card offline">
                    <h3>Desconectados</h3>
                    <div class="value" x-text="devices.filter(d => !d.is_online).length"></div>
                </div>
            </div>

            <!-- Devices View -->
            <div x-show="currentView === 'devices'">
                <div class="device-grid">
                    <template x-for="device in devices" :key="device.id">
                        <div class="device-card">
                            <div class="device-header">
                                <h3 x-text="device.name"></h3>
                                <div class="status" :class="{ online: device.is_online }"></div>
                            </div>
                            <div class="device-body">
                                <div class="device-info">
                                    <p><strong>MAC:</strong> <span x-text="device.mac_address"></span></p>
                                    <p><strong>IP:</strong> <span x-text="device.ip_address || 'N/A'"></span></p>
                                    <p><strong>Firmware:</strong> <span x-text="device.firmware_version || 'N/A'"></span></p>
                                    <p><strong>√öltima conexi√≥n:</strong> <span x-text="device.last_seen ? formatDate(device.last_seen) : 'N/A'"></span></p>
                                </div>

                                <div class="device-sensors" x-show="deviceData[device.mac_address]">
                                    <!-- Mostrar todos los sensores DHT -->
                                    <template x-if="deviceData[device.mac_address]?.dht && deviceData[device.mac_address].dht.length > 0">
                                        <template x-for="(sensor, index) in deviceData[device.mac_address].dht" :key="index">
                                            <div class="sensor-group">
                                                <div class="sensor-name" x-text="sensor.name || ('DHT ' + sensor.pin)"></div>
                                                <div class="sensor-values">
                                                    <div class="sensor">
                                                        <div class="label">Temp</div>
                                                        <div class="value" x-text="(sensor.temperature?.toFixed(1) || '--') + '¬∞C'"></div>
                                                    </div>
                                                    <div class="sensor">
                                                        <div class="label">Hum</div>
                                                        <div class="value" x-text="(sensor.humidity?.toFixed(0) || '--') + '%'"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </template>
                                    <!-- Fallback para formato antiguo -->
                                    <template x-if="!deviceData[device.mac_address]?.dht && deviceData[device.mac_address]?.temperature">
                                        <div class="sensor-group">
                                            <div class="sensor-values">
                                                <div class="sensor">
                                                    <div class="label">Temperatura</div>
                                                    <div class="value" x-text="(deviceData[device.mac_address]?.temperature || '--') + '¬∞C'"></div>
                                                </div>
                                                <div class="sensor">
                                                    <div class="label">Humedad</div>
                                                    <div class="value" x-text="(deviceData[device.mac_address]?.humidity || '--') + '%'"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <div class="device-actions">
                                    <button class="btn btn-success btn-sm" @click="openControlPanel(device)" :disabled="!device.is_online">
                                        Panel
                                    </button>
                                    <button class="btn btn-primary btn-sm" @click="openDeviceModal(device)">
                                        Config
                                    </button>
                                    <button class="btn btn-danger btn-sm" @click="rebootDevice(device)" :disabled="!device.is_online">
                                        Reiniciar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <p x-show="devices.length === 0" class="text-gray mt-20">
                    No hay dispositivos registrados. Los dispositivos aparecer√°n autom√°ticamente cuando se conecten.
                </p>
            </div>

            <!-- Firmware View -->
            <div x-show="currentView === 'firmware'">
                <div class="mb-20">
                    <h3>Subir Nuevo Firmware</h3>
                    <form @submit.prevent="uploadFirmware()" class="mt-20">
                        <div class="form-group">
                            <label>Versi√≥n</label>
                            <input type="text" x-model="newFirmware.version" placeholder="ej: 1.0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <input type="text" x-model="newFirmware.description" placeholder="Cambios en esta versi√≥n">
                        </div>
                        <div class="form-group">
                            <label>Archivo .bin</label>
                            <input type="file" @change="newFirmware.file = $event.target.files[0]" accept=".bin" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Subir Firmware</button>
                    </form>
                </div>

                <div class="table-container mt-20">
                    <table>
                        <thead>
                            <tr>
                                <th>Versi√≥n</th>
                                <th>Descripci√≥n</th>
                                <th>Tama√±o</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="fw in firmwareList" :key="fw.id">
                                <tr>
                                    <td>
                                        <span x-text="fw.version"></span>
                                        <span x-show="fw.is_active" class="text-success">(activo)</span>
                                    </td>
                                    <td x-text="fw.description || '-'"></td>
                                    <td x-text="formatBytes(fw.filesize)"></td>
                                    <td x-text="formatDate(fw.uploaded_at)"></td>
                                    <td>
                                        <button class="btn btn-sm btn-success" @click="activateFirmware(fw.id)" x-show="!fw.is_active">
                                            Activar
                                        </button>
                                        <button class="btn btn-sm btn-primary" @click="updateAllDevices(fw.id)">
                                            Enviar a todos
                                        </button>
                                        <button class="btn btn-sm btn-danger" @click="deleteFirmware(fw.id)">
                                            Eliminar
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings View -->
            <div x-show="currentView === 'settings'">
                <div class="table-container">
                    <div style="padding: 20px;">
                        <h3>Cambiar Contrase√±a</h3>
                        <form @submit.prevent="changePassword()" class="mt-20">
                            <div class="form-group">
                                <label>Contrase√±a Actual</label>
                                <input type="password" x-model="passwordForm.current" required>
                            </div>
                            <div class="form-group">
                                <label>Nueva Contrase√±a</label>
                                <input type="password" x-model="passwordForm.new" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Cambiar</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Device Config Modal -->
    <div class="modal-overlay" x-show="showDeviceModal" @click.self="showDeviceModal = false" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 x-text="selectedDevice?.name"></h2>
                <button class="modal-close" @click="showDeviceModal = false">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab" :class="{ active: deviceTab === 'info' }" @click="deviceTab = 'info'">Info</div>
                    <div class="tab" :class="{ active: deviceTab === 'gpio' }" @click="deviceTab = 'gpio'">GPIO</div>
                    <div class="tab" :class="{ active: deviceTab === 'dht' }" @click="deviceTab = 'dht'">DHT</div>
                    <div class="tab" :class="{ active: deviceTab === 'ultrasonic' }" @click="deviceTab = 'ultrasonic'">Ultrasonic</div>
                </div>

                <!-- Info Tab -->
                <div class="tab-content" :class="{ active: deviceTab === 'info' }">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" x-model="selectedDevice.name">
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea x-model="selectedDevice.description" rows="3"></textarea>
                    </div>
                    <button class="btn btn-primary" @click="saveDevice()">Guardar</button>
                </div>

                <!-- GPIO Tab -->
                <div class="tab-content" :class="{ active: deviceTab === 'gpio' }">
                    <div class="form-group">
                        <label>Agregar GPIO</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" x-model="newGpio.pin" placeholder="Pin" style="width: 80px;">
                            <select x-model="newGpio.mode">
                                <option value="OUTPUT">OUTPUT</option>
                                <option value="INPUT">INPUT</option>
                                <option value="INPUT_PULLUP">INPUT_PULLUP</option>
                                <option value="PWM">PWM</option>
                            </select>
                            <input type="text" x-model="newGpio.name" placeholder="Nombre">
                            <button class="btn btn-success btn-sm" @click="addGpio()">+</button>
                        </div>
                    </div>

                    <table class="mt-20">
                        <thead>
                            <tr>
                                <th>Pin</th>
                                <th>Nombre</th>
                                <th>Modo</th>
                                <th>Valor</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="gpio in deviceGpios" :key="gpio.pin">
                                <tr>
                                    <td x-text="gpio.pin"></td>
                                    <td x-text="gpio.name"></td>
                                    <td x-text="gpio.mode"></td>
                                    <td>
                                        <template x-if="gpio.mode === 'OUTPUT'">
                                            <button class="btn btn-sm"
                                                    :class="gpio.value ? 'btn-success' : 'btn-danger'"
                                                    @click="toggleGpio(gpio)">
                                                <span x-text="gpio.value ? 'ON' : 'OFF'"></span>
                                            </button>
                                        </template>
                                        <template x-if="gpio.mode === 'PWM'">
                                            <input type="range" min="0" max="255" x-model="gpio.value"
                                                   @change="setGpioValue(gpio)">
                                        </template>
                                        <template x-if="gpio.mode.includes('INPUT')">
                                            <span x-text="gpio.value"></span>
                                        </template>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" @click="deleteGpio(gpio.pin)">X</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- DHT Tab -->
                <div class="tab-content" :class="{ active: deviceTab === 'dht' }">
                    <div class="form-group">
                        <label>Agregar Sensor DHT</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" x-model="newDht.pin" placeholder="Pin" style="width: 80px;">
                            <select x-model="newDht.sensor_type">
                                <option value="DHT11">DHT11</option>
                                <option value="DHT22">DHT22</option>
                            </select>
                            <input type="text" x-model="newDht.name" placeholder="Nombre">
                            <button class="btn btn-success btn-sm" @click="addDht()">+</button>
                        </div>
                    </div>

                    <table class="mt-20">
                        <thead>
                            <tr>
                                <th>Pin</th>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="dht in deviceDhts" :key="dht.pin">
                                <tr>
                                    <td x-text="dht.pin"></td>
                                    <td x-text="dht.name"></td>
                                    <td x-text="dht.sensor_type"></td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" @click="deleteDht(dht.pin)">X</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Ultrasonic Tab -->
                <div class="tab-content" :class="{ active: deviceTab === 'ultrasonic' }">
                    <!-- Radar Display -->
                    <div class="radar-container" x-show="deviceUltrasonics.length > 0">
                        <canvas id="radarCanvas" width="300" height="300"></canvas>
                        <div class="radar-info">
                            <div class="distance-display">
                                <span class="label">Distancia:</span>
                                <span class="value" x-text="(currentDistance || '--') + ' cm'"></span>
                            </div>
                            <div class="detection-status" :class="{ detected: isObjectDetected }">
                                <span x-text="isObjectDetected ? (detectedAnimal ? detectedAnimal.toUpperCase() : 'DETECTADO') : 'Sin detecci√≥n'"></span>
                            </div>
                            <div class="speed-display" x-show="currentSpeed > 0">
                                <span class="label">Velocidad:</span>
                                <span class="value" x-text="currentSpeed + ' cm/s'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Add Ultrasonic Form -->
                    <div class="form-group mt-20">
                        <label>Agregar Sensor HC-SR04</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="number" x-model="newUltrasonic.trig_pin" placeholder="TRIG Pin" style="width: 90px;">
                            <input type="number" x-model="newUltrasonic.echo_pin" placeholder="ECHO Pin" style="width: 90px;">
                            <input type="text" x-model="newUltrasonic.name" placeholder="Nombre" style="width: 120px;">
                            <button class="btn btn-success btn-sm" @click="addUltrasonic()">+</button>
                        </div>
                    </div>

                    <!-- Ultrasonic Sensors List -->
                    <template x-for="ultrasonic in deviceUltrasonics" :key="ultrasonic.id">
                        <div class="ultrasonic-card mt-20">
                            <div class="ultrasonic-header">
                                <h4 x-text="ultrasonic.name"></h4>
                                <button class="btn btn-danger btn-sm" @click="deleteUltrasonic(ultrasonic.id)">X</button>
                            </div>
                            <div class="ultrasonic-config">
                                <div class="config-row">
                                    <span>TRIG: <strong x-text="ultrasonic.trig_pin"></strong></span>
                                    <span>ECHO: <strong x-text="ultrasonic.echo_pin"></strong></span>
                                </div>

                                <!-- Detection Settings -->
                                <div class="config-section">
                                    <h5>Detecci√≥n</h5>
                                    <div class="config-row">
                                        <label>
                                            <input type="checkbox" x-model="ultrasonic.detection_enabled" @change="updateUltrasonic(ultrasonic)">
                                            Habilitar detecci√≥n
                                        </label>
                                    </div>
                                    <div class="config-row">
                                        <label>Distancia de activaci√≥n (cm):</label>
                                        <input type="number" x-model="ultrasonic.trigger_distance" @change="updateUltrasonic(ultrasonic)" style="width: 80px;">
                                    </div>
                                    <div class="config-row">
                                        <label>GPIO a activar:</label>
                                        <input type="number" x-model="ultrasonic.trigger_gpio_pin" @change="updateUltrasonic(ultrasonic)" style="width: 80px;">
                                    </div>
                                    <div class="config-row">
                                        <label>Valor al detectar:</label>
                                        <select x-model="ultrasonic.trigger_gpio_value" @change="updateUltrasonic(ultrasonic)">
                                            <option value="1">HIGH (1)</option>
                                            <option value="0">LOW (0)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Smart Detection -->
                                <div class="config-section">
                                    <h5>Detecci√≥n Inteligente</h5>
                                    <div class="config-row">
                                        <label>
                                            <input type="checkbox" x-model="ultrasonic.smart_detection_enabled" @change="updateUltrasonic(ultrasonic)">
                                            Habilitar detecci√≥n inteligente
                                        </label>
                                    </div>
                                    <div class="config-row" x-show="ultrasonic.smart_detection_enabled">
                                        <label>Detectar:</label>
                                        <select x-model="ultrasonic.animal_type" @change="updateUltrasonic(ultrasonic)">
                                            <option value="any">Cualquiera</option>
                                            <option value="cat">Solo Gatos</option>
                                            <option value="mouse">Solo Ratones</option>
                                            <option value="both">Gatos y Ratones</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <p x-show="deviceUltrasonics.length === 0" class="text-gray mt-20">
                        No hay sensores ultras√≥nicos configurados.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel Modal -->
    <div class="modal-overlay control-panel-overlay" x-show="showControlPanel" @click.self="closeControlPanel()" style="display: none;">
        <div class="control-panel-modal">
            <div class="modal-header">
                <h2>
                    <span class="status-dot" :class="{ online: controlPanelDevice?.is_online }"></span>
                    <span x-text="controlPanelDevice?.name"></span>
                </h2>
                <button class="modal-close" @click="closeControlPanel()">&times;</button>
            </div>
            <div class="control-panel-body">
                <!-- Top Row: Radar + Sensors -->
                <div class="control-panel-grid">
                    <!-- Radar Section -->
                    <div class="panel-section radar-section" x-show="panelUltrasonics.length > 0">
                        <h3>Sensor Ultras√≥nico</h3>
                        <div class="radar-display">
                            <canvas id="controlRadarCanvas" width="250" height="250"></canvas>
                        </div>
                        <div class="radar-stats">
                            <div class="stat">
                                <span class="stat-label">Distancia</span>
                                <span class="stat-value" x-text="(panelDistance || '--') + ' cm'"></span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">Estado</span>
                                <span class="stat-value detection-badge" :class="{ detected: panelDetected }">
                                    <span x-text="panelDetected ? (panelAnimal ? panelAnimal.toUpperCase() : 'DETECTADO') : 'Libre'"></span>
                                </span>
                            </div>
                            <div class="stat" x-show="panelSpeed > 0">
                                <span class="stat-label">Velocidad</span>
                                <span class="stat-value" x-text="panelSpeed + ' cm/s'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- DHT Sensors Section -->
                    <div class="panel-section sensors-section" x-show="panelDhts.length > 0">
                        <h3>Sensores Ambientales</h3>
                        <div class="sensor-cards">
                            <template x-for="dht in panelDhts" :key="dht.pin">
                                <div class="sensor-card-large">
                                    <div class="sensor-card-name" x-text="dht.name || ('DHT ' + dht.pin)"></div>
                                    <div class="sensor-card-values">
                                        <div class="sensor-item">
                                            <div class="sensor-icon temp-icon">üå°Ô∏è</div>
                                            <div class="sensor-data">
                                                <span class="sensor-value" x-text="(panelSensorData.dht?.[dht.pin]?.temperature?.toFixed(1) || '--')"></span>
                                                <span class="sensor-unit">¬∞C</span>
                                            </div>
                                        </div>
                                        <div class="sensor-item">
                                            <div class="sensor-icon hum-icon">üíß</div>
                                            <div class="sensor-data">
                                                <span class="sensor-value" x-text="(panelSensorData.dht?.[dht.pin]?.humidity?.toFixed(0) || '--')"></span>
                                                <span class="sensor-unit">%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- GPIO Controls Section -->
                <div class="panel-section gpio-section" x-show="panelGpios.length > 0">
                    <h3>Control de GPIOs</h3>
                    <div class="gpio-controls-grid">
                        <template x-for="gpio in panelGpios" :key="gpio.pin">
                            <div class="gpio-control-card" :class="{ 'gpio-input': gpio.mode.includes('INPUT') }">
                                <div class="gpio-control-header">
                                    <span class="gpio-name" x-text="gpio.name || ('GPIO ' + gpio.pin)"></span>
                                    <span class="gpio-pin">Pin <span x-text="gpio.pin"></span></span>
                                </div>
                                <div class="gpio-control-body">
                                    <!-- OUTPUT: Switch Toggle -->
                                    <template x-if="gpio.mode === 'OUTPUT'">
                                        <div class="switch-container">
                                            <label class="switch">
                                                <input type="checkbox" :checked="gpio.value == 1" @change="togglePanelGpio(gpio)">
                                                <span class="slider round"></span>
                                            </label>
                                            <span class="switch-label" x-text="gpio.value ? 'ON' : 'OFF'" :class="{ on: gpio.value }"></span>
                                        </div>
                                    </template>
                                    <!-- PWM: Slider -->
                                    <template x-if="gpio.mode === 'PWM'">
                                        <div class="pwm-container">
                                            <input type="range" min="0" max="255" x-model="gpio.value" @change="setPanelGpioValue(gpio)" class="pwm-slider">
                                            <div class="pwm-value">
                                                <span x-text="gpio.value"></span>
                                                <span class="pwm-percent" x-text="'(' + Math.round(gpio.value / 255 * 100) + '%)'"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <!-- INPUT: Read Only -->
                                    <template x-if="gpio.mode.includes('INPUT')">
                                        <div class="input-display">
                                            <template x-if="gpio.isAnalog">
                                                <div class="analog-display">
                                                    <div class="analog-bar">
                                                        <div class="analog-fill" :style="'width: ' + (gpio.value / 4095 * 100) + '%'"></div>
                                                    </div>
                                                    <span class="analog-value" x-text="gpio.value"></span>
                                                </div>
                                            </template>
                                            <template x-if="!gpio.isAnalog">
                                                <div class="digital-display" :class="{ high: gpio.value }">
                                                    <span x-text="gpio.value ? 'HIGH' : 'LOW'"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="panel-empty" x-show="panelGpios.length === 0 && panelDhts.length === 0 && panelUltrasonics.length === 0">
                    <p>No hay sensores ni GPIOs configurados.</p>
                    <button class="btn btn-primary" @click="closeControlPanel(); openDeviceModal(controlPanelDevice)">
                        Configurar dispositivo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
</body>
</html>
